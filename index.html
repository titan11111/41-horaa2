<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>家の見取り図 3D — 一人称探索ホラー（統合・モバイル簡易対応）</title>
<style>
:root{
  --bg:#0d0f12;--fg:#e6e6e6;--muted:#bbbbbb;--accent:#c0392b;--panel:#12151a;--line:#2a2f36;--hint:#92a3ff;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;overflow:hidden;}
/* Loading */
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:1;transition:opacity .5s}
.loading-screen.hidden{opacity:0;pointer-events:none}
.loading-content{text-align:center;max-width:420px}
.loading-bar{width:100%;height:8px;background:var(--line);border-radius:4px;overflow:hidden;margin:14px 0}
.loading-progress{height:100%;background:linear-gradient(90deg,var(--accent),var(--hint));width:0%;animation:lp 2.2s ease-out forwards}
@keyframes lp{0%{width:0}100%{width:100%}}
/* Layout */
.wrap{display:grid;grid-template-columns:1.6fr .6fr;gap:18px;height:100%;padding:16px;box-sizing:border-box;display:none}
header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg,#0f1318,#0b0e12);border:1px solid var(--line);border-radius:12px}
header h1{font-size:16px;margin:0;font-weight:600}
header .status{font-size:12px;opacity:.85}
/* 3D */
.main-3d{position:relative;background:linear-gradient(180deg,#0e1319,#0a0d11);border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.03) inset}
#game3d{width:100%;height:100%;display:block;background:#000}
.controls-overlay{position:absolute;inset:0;pointer-events:none;z-index:10}
.crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:rgba(255,255,255,.85);font-size:20px;font-weight:700;text-shadow:0 0 4px rgba(0,0,0,.8)}
.movement-hint{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);padding:8px 16px;border-radius:8px;border:1px solid var(--line)}
.hint-text{font-size:12px;color:var(--muted);text-align:center}
.lock-hint{position:absolute;top:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:6px 10px;border-radius:8px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
/* Interact prompt */
.interaction-prompt{position:absolute;top:50%;left:50%;transform:translate(-50%,-120px);background:rgba(0,0,0,.85);padding:12px 20px;border-radius:8px;border:2px solid var(--accent);font-size:14px;font-weight:700;color:var(--fg);text-align:center;opacity:0;transition:opacity .2s;z-index:20;pointer-events:none}
.interaction-prompt.visible{opacity:1}
/* Map */
.map{padding:14px;display:grid;grid-template-rows:auto 1fr auto auto;background:linear-gradient(180deg,#0e1319,#0a0d11);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.03) inset}
#blueprint{width:100%;height:280px;background:#0a0d11;border-radius:12px;border:1px dashed #24303d}
.legend{display:flex;gap:8px;flex-wrap:wrap;padding-top:8px;font-size:11px;color:var(--muted)}
.legend span{display:inline-flex;align-items:center;gap:4px}
.chip{width:10px;height:10px;border-radius:2px;display:inline-block;border:1px solid var(--line)}
.inventory{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;font-size:12px;color:var(--muted)}
.room-info{background:rgba(18,21,26,.8);border:1px solid var(--line);border-radius:8px;padding:12px;margin-top:8px}
.room-info h3{font-size:16px;margin:0 0 8px 0}
.room-info p{font-size:12px;line-height:1.6;margin:0;color:var(--muted)}
/* Screen FX + Toast */
.crt{position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(0deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,rgba(0,0,0,0) 2px),radial-gradient(ellipse at center,rgba(255,255,255,.04),transparent 70%);mix-blend-mode:soft-light;opacity:.4;animation:flicker 6s linear infinite;z-index:5}
@keyframes flicker{0%{opacity:.35}50%{opacity:.45}100%{opacity:.35}}
.toast{position:fixed;left:50%;top:80px;transform:translateX(-50%);background:rgba(12,17,22,.95);border:1px solid var(--line);color:var(--fg);padding:12px 16px;border-radius:10px;font-size:14px;font-weight:600;opacity:0;transition:opacity .25s,transform .25s;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(10px)}
/* Mobile controls (simple move + fixed view) */
.mobile-controls{position:absolute;inset:auto 0 12px 0;display:none;justify-content:space-between;align-items:end;padding:0 12px;pointer-events:auto;z-index:30}
.dpad{display:grid;grid-template-columns:48px 48px 48px;grid-template-rows:48px 48px;gap:6px}
.dpad button{background:rgba(255,255,255,.1);color:#fff;border:1px solid #555;border-radius:8px;font-size:18px}
.dpad .sp{visibility:hidden}
#touchInteract{background:#c0392b;color:#fff;border:none;border-radius:10px;padding:12px 18px;font-size:14px}
@media (max-width:960px){
  .wrap{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}
  #blueprint{height:220px}
}
@media (max-width:600px){
  .wrap{padding:8px;gap:12px}
  .movement-hint{bottom:10px;padding:6px 12px}
  #blueprint{height:160px}
  header h1{font-size:14px}
  header .status{font-size:11px}
}
</style>
</head>
<body>
  <!-- Loading -->
  <div id="loading" class="loading-screen">
    <div class="loading-content">
      <h2>家の見取り図 3D</h2>
      <div class="loading-bar"><div class="loading-progress"></div></div>
      <p>3D世界を構築中…</p>
    </div>
  </div>

  <!-- Main -->
  <div class="wrap" id="gameWrap">
    <header>
      <h1>家の見取り図 3D <span style="font-weight:400;opacity:.65">— 図面は更新されます</span></h1>
      <div class="status">章: <span id="chapter">1</span> / 不一致度: <span id="desync">0%</span></div>
    </header>

    <section class="main-3d">
      <canvas id="game3d" width="800" height="600"></canvas>

      <div class="controls-overlay">
        <div class="lock-hint" id="lockHint">クリックで視点ロック（解除: Esc）</div>
        <div class="crosshair">+</div>
        <div class="movement-hint"><div class="hint-text">WASD: 移動 / マウス: 視点 / E: 調べる</div></div>
      </div>

      <!-- Interact prompt -->
      <div id="interaction" class="interaction-prompt"><span id="interactionText">Eキーで調べる</span></div>

      <!-- Mobile simple controls -->
      <div id="mobileControls" class="mobile-controls" aria-hidden="true">
        <div class="dpad">
          <div class="sp"></div><button data-dir="up"  aria-label="北へ">↑</button><div class="sp"></div>
          <button data-dir="left" aria-label="西へ">←</button><button data-dir="down" aria-label="南へ">↓</button><button data-dir="right" aria-label="東へ">→</button>
        </div>
        <button id="touchInteract" aria-label="調べる">調べる</button>
      </div>
    </section>

    <aside class="map">
      <h2>家の見取り図</h2>
      <canvas id="blueprint" width="500" height="360" aria-label="見取り図"></canvas>
      <div class="legend">
        <span><i class="chip" style="background:#14202b"></i> 既知の部屋</span>
        <span><i class="chip" style="background:#243447"></i> 不一致の疑い</span>
        <span><i class="chip" style="background:#5b1a16"></i> 赤い部屋</span>
        <span><i class="chip" style="background:#1e2f22"></i> あなた</span>
      </div>
      <div class="inventory">
        <div>所持：<span id="inventory">古い見取り図</span></div>
        <div id="clock">00:00</div>
      </div>
      <div class="room-info">
        <h3 id="roomTitle">玄関</h3>
        <p id="roomDescription">湿った靴の匂い。傘立てには折れた骨のような傘。</p>
      </div>
    </aside>
  </div>

  <div class="crt"></div>
  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
  (()=>{"use strict";

  /* ======== State ======== */
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || matchMedia("(pointer: coarse)").matches;
  const state = {
    chapter:1, steps:0, desync:0,
    currentRoom:'玄関',
    visited:new Set(['玄関']),
    inventory:['古い見取り図'],
    clock:23*60+40,
    gameEnded:false,
    yaw:0, pitch:0, locked:false
  };

  /* ======== Rooms (+ more furniture) ======== */
  const rooms = {
    '玄関':{
      position3D:{x:0,y:0,z:0},
      exits:{東:'廊下'},
      description:'湿った靴の匂い。傘立てには折れた骨のような傘。壁のフックに見取り図が掛かっている。',
      color:0x2a3f54,
      furniture:[
        {name:'フックの見取り図',kind:'prop',pos:[-2.6,0,-3.2],size:[0.9,0.6,0.05],action:'mapHook'},
        {name:'下駄箱',kind:'box',pos:[2.4,0,-2.4],size:[2.2,1.0,0.6],action:'shoeBox'},
        {name:'姿見の鏡',kind:'prop',pos:[0,0,3.7],size:[0.8,2.0,0.05],action:'mirror'},
        {name:'古い電話',kind:'box',pos:[-2.0,0,0.8],size:[0.5,0.3,0.5],action:'oldPhone'}
      ]
    },
    '廊下':{
      position3D:{x:10,y:0,z:0},
      exits:{西:'玄関',東:'居間',南:'階段'},
      description:'細い廊下。壁紙がところどころ浮いている。天井から低い音。',
      color:0x1a2f3f,
      furniture:[
        {name:'額縁',kind:'prop',pos:[0,0,-3.8],size:[0.7,0.5,0.05],action:'frame'},
        {name:'傘立て',kind:'box',pos:[-3.4,0,2.6],size:[0.6,0.8,0.6],action:'umbrella'},
        {name:'掛け時計',kind:'prop',pos:[3.6,1.4,0],size:[0.4,0.4,0.05],action:'clock'}
      ]
    },
    '居間':{
      position3D:{x:20,y:0,z:0},
      exits:{西:'廊下',南:'台所'},
      description:'薄暗い居間。テレビは砂嵐。テーブルにコップの輪染み。',
      color:0x3f2a1a,
      furniture:[
        {name:'テレビ',kind:'box',pos:[0,0,-3.1],size:[1.2,0.9,0.4],action:'tv'},
        {name:'テーブル',kind:'box',pos:[0,0,0],size:[1.8,0.5,1.4],action:'table'},
        {name:'ソファ',kind:'box',pos:[-2.2,0,2.0],size:[2.6,1.0,1.2],action:'sofa'},
        {name:'本棚',kind:'box',pos:[2.6,0,2.2],size:[1.4,2.0,0.6],action:'bookshelf'}
      ]
    },
    '台所':{
      position3D:{x:20,y:0,z:10},
      exits:{北:'居間',西:'物置'},
      description:'流しに水が残っている。冷蔵庫が間欠的に唸る。',
      color:0x2f3f2a,
      furniture:[
        {name:'冷蔵庫',kind:'box',pos:[2.6,0,-2.2],size:[1.2,2.0,1.0],action:'fridge'},
        {name:'流し',kind:'box',pos:[-2.6,0,-2.2],size:[2.0,0.9,1.0],action:'sink'},
        {name:'包丁立て',kind:'prop',pos:[-2.1,0,-1.6],size:[0.3,0.5,0.3],action:'knifeStand'},
        {name:'食器棚',kind:'box',pos:[0,0,2.6],size:[2.2,1.8,0.6],action:'cupboard'}
      ]
    },
    '物置':{
      position3D:{x:10,y:0,z:10},
      exits:{東:'台所'},
      description:'段ボールが積まれている。見取り図の予備が散乱。',
      color:0x3f3f2a,
      furniture:[
        {name:'段ボール',kind:'box',pos:[0,0,0.8],size:[2.2,1.4,1.8],action:'boxes'},
        {name:'古いラジオ',kind:'box',pos:[-1.8,0,-1.2],size:[0.8,0.5,0.5],action:'radio'},
        {name:'棚',kind:'box',pos:[2.4,0,2.0],size:[1.6,2.0,0.6],action:'shelf'}
      ]
    },
    '階段':{
      position3D:{x:10,y:0,z:15},
      exits:{北:'廊下'},
      description:'踏むたびに鳴る。二段目だけ音がしない。',
      color:0x4a3a2a,
      furniture:[
        {name:'階段（上る）',kind:'box',pos:[0,0,1.6],size:[1.8,1.2,2.8],action:'stairsUp'},
        {name:'手すり',kind:'prop',pos:[-3.6,0,0],size:[0.2,2.2,3.6],action:'railing'}
      ]
    },
    '二階廊下':{
      position3D:{x:10,y:5,z:15},
      exits:{東:'寝室',西:'子ども部屋'},
      description:'二階の廊下は異様に長い。窓の外は月明かり。',
      color:0x2a2a4a,
      furniture:[
        {name:'階段（下りる）',kind:'box',pos:[0,0,1.6],size:[1.8,1.2,2.8],action:'stairsDown'},
        {name:'花瓶',kind:'box',pos:[1.8,0,0.8],size:[0.4,0.8,0.4],action:'vase'},
        {name:'窓',kind:'prop',pos:[0,1.2,-3.8],size:[2.0,1.2,0.05],action:'window'}
      ]
    },
    '寝室':{
      position3D:{x:20,y:5,z:15},
      exits:{西:'二階廊下'},
      description:'ベッドが一つ。掛け布団は人の形で膨らんでいる。',
      color:0x4a2a3a,
      furniture:[
        {name:'ベッド',kind:'box',pos:[0,0,0.2],size:[2.6,0.8,2.0],action:'bed'},
        {name:'クローゼット',kind:'box',pos:[-2.8,0,2.4],size:[1.6,2.2,0.8],action:'closet'},
        {name:'ランプ',kind:'box',pos:[1.6,0,-0.2],size:[0.4,0.9,0.4],action:'lamp'}
      ]
    },
    '子ども部屋':{
      position3D:{x:0,y:5,z:15},
      exits:{東:'二階廊下'},
      description:'壁に落書き。背の高い影と、赤い四角。',
      color:0x3a2a4a,
      furniture:[
        {name:'おもちゃ箱',kind:'box',pos:[-1.6,0,0.6],size:[1.2,0.8,1.0],action:'toybox'},
        {name:'机',kind:'box',pos:[1.6,0,0.2],size:[1.6,0.8,0.9],action:'desk'},
        {name:'落書きの壁',kind:'prop',pos:[0,0,-3.8],size:[2.2,1.2,0.05],action:'graffiti'}
      ]
    }
  };

  /* ======== Elements ======== */
  const el = {
    loading:document.getElementById('loading'),
    gameWrap:document.getElementById('gameWrap'),
    game3d:document.getElementById('game3d'),
    roomTitle:document.getElementById('roomTitle'),
    roomDescription:document.getElementById('roomDescription'),
    blueprint:document.getElementById('blueprint'),
    chapter:document.getElementById('chapter'),
    desync:document.getElementById('desync'),
    inventory:document.getElementById('inventory'),
    clock:document.getElementById('clock'),
    toast:document.getElementById('toast'),
    interaction:document.getElementById('interaction'),
    interactionText:document.getElementById('interactionText'),
    lockHint:document.getElementById('lockHint'),
    mobileControls:document.getElementById('mobileControls'),
    touchInteract:document.getElementById('touchInteract')
  };

  /* ======== Three.js ======== */
  let scene,camera,renderer;
  const roomGroups = {};
  const interactables = {};
  const raycaster = new THREE.Raycaster();
  const tmpV3 = new THREE.Vector3();
  let keys = Object.create(null);
  let lastBlueprintGlitchAt = 0;

  /* ======== Audio (system-like) ======== */
  let audioCtx = null;
  function ensureAudio(){
    try{
      if(!audioCtx){
        const Ctx = window.AudioContext || window.webkitAudioContext;
        audioCtx = new Ctx();
      }
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }catch(e){ /* 無音でも動作可能 */ }
  }
  function beep(type='notify', dur=0.25, vol=0.18){
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.connect(g).connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    let f = 660;
    let wave = 'sine';
    if(type==='chime'){ f=880; wave='triangle'; }
    if(type==='buzz'){ f=120; wave='square'; vol=0.12; }
    osc.type = wave;
    osc.frequency.setValueAtTime(f, t);
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(vol, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    osc.start(t); osc.stop(t+dur);
  }

  /* ======== Utils ======== */
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
  const showMessage=(m)=>{el.toast.textContent=m;el.toast.classList.add('show');setTimeout(()=>el.toast.classList.remove('show'),1600);};
  const showInteraction=(t)=>{el.interactionText.textContent=t;el.interaction.classList.add('visible');};
  const hideInteraction=()=>el.interaction.classList.remove('visible');

  /* ======== 3D init ======== */
  function init3D(){
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000000, 10, 50);

    camera = new THREE.PerspectiveCamera(75, el.game3d.clientWidth/el.game3d.clientHeight, 0.1, 200);
    camera.position.set(0,1.6,0);

    renderer = new THREE.WebGLRenderer({canvas:el.game3d, antialias:true});
    renderer.setSize(el.game3d.clientWidth, el.game3d.clientHeight);
    renderer.setClearColor(0x000000);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const amb = new THREE.AmbientLight(0x404040, .35); scene.add(amb);
    const spot = new THREE.SpotLight(0xffffff, 1.0, 24, Math.PI/6, 0.5);
    spot.position.set(0,0,0); spot.castShadow = true; camera.add(spot); scene.add(camera);

    createRooms();
    movePlayerToRoom('玄関','東',true);
  }

  function createRooms(){
    Object.entries(rooms).forEach(([name,d])=>{
      const g = new THREE.Group();
      // Floor
      const floor = new THREE.Mesh(new THREE.PlaneGeometry(8,8), new THREE.MeshLambertMaterial({color:d.color,transparent:true,opacity:.85}));
      floor.rotation.x = -Math.PI/2; floor.receiveShadow=true; g.add(floor);
      // Walls
      const wallGeo = new THREE.PlaneGeometry(8,3);
      const wallMat = new THREE.MeshLambertMaterial({color:d.color,transparent:true,opacity:.65});
      const walls = [
        [0,1.5,-4,0], [0,1.5,4,Math.PI], [4,1.5,0,-Math.PI/2], [-4,1.5,0,Math.PI/2]
      ];
      for(const [x,y,z,ry] of walls){ const w = new THREE.Mesh(wallGeo,wallMat); w.position.set(x,y,z); w.rotation.y=ry; g.add(w); }

      // Furniture / props
      const list=[];
      (d.furniture||[]).forEach(f=>{
        const geo = new THREE.BoxGeometry(f.size[0], f.size[1], f.size[2]);
        const mat = new THREE.MeshLambertMaterial({color:(f.kind==='prop'?0x555566:0x444444),emissive:0x111111});
        const m = new THREE.Mesh(geo, mat);
        // elevate box to sit on floor
        m.position.set(f.pos[0], Math.max(0.25, f.pos[1] + f.size[1]/2 - 0.4), f.pos[2]);
        m.userData = {type:'interact', room:name, item:f};
        m.castShadow = (f.kind!=='prop'); m.receiveShadow = (f.kind!=='prop');
        g.add(m); list.push(m);
      });

      g.position.set(d.position3D.x,d.position3D.y,d.position3D.z);
      scene.add(g);
      roomGroups[name]=g;
      interactables[name]=list;
    });
  }

  /* ======== UI & Map ======== */
  function updateUI(){
    el.roomTitle.textContent = state.currentRoom;
    el.roomDescription.textContent = rooms[state.currentRoom]?.description || '';
    el.chapter.textContent = state.chapter;
    el.desync.textContent = state.desync + '%';
    el.inventory.textContent = state.inventory.join('、');
  }
  function advanceTime(min=1){
    state.clock = (state.clock + min) % (24*60);
    const h = String(Math.floor(state.clock/60)).padStart(2,'0');
    const m = String(state.clock%60).padStart(2,'0');
    el.clock.textContent = `${h}:${m}`;
  }
  function updateBlueprint(){
    const ctx = el.blueprint.getContext('2d');
    const w = el.blueprint.width, h = el.blueprint.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#0b0f14'; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#16202b'; ctx.lineWidth=1;
    for(let x=0;x<=10;x++){ ctx.beginPath(); ctx.moveTo(40+x*40,20); ctx.lineTo(40+x*40,h-20); ctx.stroke(); }
    for(let y=0;y<=8;y++){ ctx.beginPath(); ctx.moveTo(40,20+y*40); ctx.lineTo(w-40,20+y*40); ctx.stroke(); }
    if(state.chapter>=4){
      ctx.fillStyle='#050709'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle='#c0d6ff'; ctx.font='12px ui-sans-serif'; ctx.fillText('叩く音がする',24,28); return;
    }
    const now = performance.now();
    const glitch = (state.desync>=55 && now - lastBlueprintGlitchAt > 6000);
    const fakeNames = ['6/12','10/03','母の部屋','A-12','メ','影','003'];
    Object.entries(rooms).forEach(([name,d])=>{
      if(!state.visited.has(name)) return;
      const x = 40 + (d.position3D.x/5)*40;
      const y = 20 + (d.position3D.z/5)*40;
      const size = 36;
      let color = '#14202b';
      if(name==='赤い部屋') color='#5b1a16';
      if(name===state.currentRoom) color='#1e2f22';
      if(state.desync>=60 && Math.random()<0.03) color='#243447';
      ctx.fillStyle=color; ctx.strokeStyle='#33414f'; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.rect(x,y,size,size); ctx.fill(); ctx.stroke();
      let label = name;
      if(glitch && state.chapter>=3 && Math.random()<0.25) label = fakeNames[(Math.random()*fakeNames.length)|0];
      ctx.fillStyle='#9fb0c1'; ctx.font='10px ui-sans-serif'; ctx.fillText(label, x+4, y+12);
    });
    if(glitch) lastBlueprintGlitchAt = performance.now();
  }

  function increaseDesync(n){
    const prev=state.desync;
    state.desync = Math.min(100, state.desync + n);
    if(prev<50 && state.desync>=50){ scene.fog.far = 30; }
    if(prev<75 && state.desync>=75){ scene.fog.far = 20; }
    updateUI();
  }

  /* ======== Input ======== */
  function setupInput(){
    document.addEventListener('keydown',(e)=>{
      ensureAudio();
      keys[e.code]=true;
      if(e.code==='KeyE') tryInteract();
    });
    document.addEventListener('keyup',(e)=>{ keys[e.code]=false; });

    if(!isMobile){
      el.game3d.addEventListener('mousedown',()=>{
        if(document.pointerLockElement!==el.game3d){
          el.game3d.requestPointerLock();
        }
      });
      document.addEventListener('pointerlockchange',()=>{
        state.locked = (document.pointerLockElement===el.game3d);
        el.lockHint.style.display = state.locked ? 'none' : 'block';
      });
      document.addEventListener('mousemove',(e)=>{
        if(!state.locked || state.gameEnded) return;
        const sens=0.002;
        state.yaw   -= e.movementX*sens;
        state.pitch -= e.movementY*sens;
        const lim = Math.PI/2-0.05;
        state.pitch = Math.max(-lim, Math.min(lim, state.pitch));
      });
    }else{
      // mobile fixed view
      state.yaw = 0; state.pitch = 0;
      el.lockHint.style.display = 'none';
      el.mobileControls.style.display = 'flex';
      el.mobileControls.setAttribute('aria-hidden','false');
      // DPAD presses (discrete exits)
      const press = (dir)=>{
        if(state.gameEnded) return;
        ensureAudio();
        const room = rooms[state.currentRoom]; if(!room) return;
        const table = {up:'北',down:'南',left:'西',right:'東'};
        const toward = table[dir];
        const next = room.exits && room.exits[toward];
        if(next){
          movePlayerToRoom(next, oppositeDir(toward));
        }else{
          showMessage('行けない');
        }
      };
      el.mobileControls.querySelectorAll('[data-dir]').forEach(btn=>{
        const dir = btn.getAttribute('data-dir');
        const handler = ()=>press(dir);
        btn.addEventListener('touchstart',handler,{passive:true});
        btn.addEventListener('click',handler);
      });
      el.touchInteract.addEventListener('touchstart',()=>{ensureAudio(); tryInteract();},{passive:true});
      el.touchInteract.addEventListener('click',()=>{ensureAudio(); tryInteract();});
      // resume audio on first gesture
      window.addEventListener('touchstart',ensureAudio,{passive:true, once:true});
    }

    window.addEventListener('resize', onResize);
    // resume audio on first click/keydown as well
    window.addEventListener('click',ensureAudio,{once:true});
  }
  function oppositeDir(d){ return ({'北':'南','南':'北','東':'西','西':'東'})[d] || '西'; }
  function onResize(){
    camera.aspect = el.game3d.clientWidth/el.game3d.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(el.game3d.clientWidth, el.game3d.clientHeight);
  }

  /* ======== Movement (desktop only continuous) ======== */
  function updateMovement(dt){
    if(isMobile) { // fixed view, no continuous movement
      camera.rotation.set(0,0,0,'YXZ'); // keep stable
      return;
    }
    const speed = 3.0;
    const mv = {x:0,z:0};
    if(keys['KeyW']) mv.z -= 1;
    if(keys['KeyS']) mv.z += 1;
    if(keys['KeyA']) mv.x -= 1;
    if(keys['KeyD']) mv.x += 1;
    const len = Math.hypot(mv.x,mv.z);
    if(len>0){ mv.x/=len; mv.z/=len; }
    const cos = Math.cos(state.yaw), sin = Math.sin(state.yaw);
    const fX = -sin, fZ = -cos;
    const rX =  cos, rZ = -sin;
    camera.position.x += (fX*mv.z + rX*mv.x)*speed*dt;
    camera.position.z += (fZ*mv.z + rZ*mv.x)*speed*dt;
    camera.rotation.set(state.pitch, state.yaw, 0, 'YXZ');
    enforceBoundsAndTransitions();
  }

  function enforceBoundsAndTransitions(){
    const name = state.currentRoom, d = rooms[name]; if(!d) return;
    const center = d.position3D;
    const lx = camera.position.x - center.x;
    const lz = camera.position.z - center.z;
    const half=3.8, m=0.2;
    // 北
    if(lz < -half){ if(d.exits && d.exits['北']){ movePlayerToRoom(d.exits['北'],'南'); return; } else { camera.position.z = center.z - half + m; } }
    // 南
    if(lz >  half){ if(d.exits && d.exits['南']){ movePlayerToRoom(d.exits['南'],'北'); return; } else { camera.position.z = center.z + half - m; } }
    // 東
    if(lx >  half){ if(d.exits && d.exits['東']){ movePlayerToRoom(d.exits['東'],'西'); return; } else { camera.position.x = center.x + half - m; } }
    // 西
    if(lx < -half){ if(d.exits && d.exits['西']){ movePlayerToRoom(d.exits['西'],'東'); return; } else { camera.position.x = center.x - half + m; } }
  }

  /* ======== Interaction ======== */
  function nearestInteractable(){
    const list = interactables[state.currentRoom]||[];
    if(isMobile){
      // fixed view: pick nearest within 2.5m
      let best=null,bd=Infinity;
      for(const o of list){
        const p = o.getWorldPosition(tmpV3);
        const d = p.distanceTo(camera.position);
        if(d<bd){ bd=d; best=o; }
      }
      if(best && bd<2.5){ showInteraction(`タップ/ E で「${best.userData.item.name}」`); return best; }
      hideInteraction(); return null;
    }else{
      raycaster.setFromCamera({x:0,y:0}, camera);
      const hits = raycaster.intersectObjects(list,false);
      if(hits.length>0 && hits[0].distance<3){
        const obj = hits[0].object;
        showInteraction(`Eキーで「${obj.userData.item.name}」を調べる`);
        return obj;
      }
      hideInteraction(); return null;
    }
  }
  function tryInteract(){
    if(state.gameEnded) return;
    const obj = nearestInteractable();
    if(!obj) return;
    doAction(obj.userData.item.action);
    checkEnding();
  }

  /* ======== Actions & Chapters ======== */
  function doAction(action){
    const act = {
      mapHook: ()=>{ showMessage('図面が少し重くなった'); increaseDesync(5); },
      shoeBox: ()=>{ showMessage('靴跡が増えている…'); increaseDesync(2); },
      mirror: ()=>{ showMessage('鏡に背の高い影が映る'); increaseDesync(3); },
      oldPhone: ()=>{ showMessage('鳴らないはずの発信音が一瞬'); increaseDesync(4); beep('notify'); },

      frame: ()=>{ showMessage('額縁の写真が裏返っている'); increaseDesync(3); },
      umbrella: ()=>{ showMessage('濡れていないのに滴る音'); increaseDesync(2); },
      clock: ()=>{ showMessage('秒針が止まっている'); increaseDesync(2); },

      tv: ()=>{ showMessage('砂嵐が一瞬だけ止まった'); if(state.chapter<=2){ addRedRoom(); changeChapter(2); showMessage('赤い部屋が、図面の端に現れた'); beep('chime'); } else { increaseDesync(4); } },
      table: ()=>{ showMessage('輪染みの跡に、合わないコップの影'); increaseDesync(2); },
      sofa: ()=>{ showMessage('座っていないのに沈む'); increaseDesync(3); },
      bookshelf: ()=>{ showMessage('背表紙が数字に置き換わる'); increaseDesync(3); },

      fridge: ()=>{ showMessage('冷蔵庫から低い唸り声…'); if(state.desync>=60 && !state.inventory.includes('正しい見取り図')){ state.inventory.push('正しい見取り図'); showMessage('「正しい見取り図」を手に入れた'); updateUI(); beep('chime'); } else { increaseDesync(2); } },
      sink: ()=>{ showMessage('水面が揺れている。風は無いのに'); increaseDesync(2); },
      knifeStand: ()=>{ showMessage('刃が一本足りない'); increaseDesync(3); },
      cupboard: ()=>{ showMessage('食器が勝手に鳴った'); increaseDesync(3); },

      boxes: ()=>{ showMessage('箱の中に別の見取り図…'); reorganize(); changeChapter(3); },
      radio: ()=>{ showMessage('知らない電波が混ざる'); increaseDesync(3); beep('buzz',0.28); },
      shelf: ()=>{ showMessage('棚の裏から冷たい風'); increaseDesync(2); },

      stairsUp: ()=>{ movePlayerToRoom('二階廊下','南'); },
      stairsDown: ()=>{ movePlayerToRoom('階段','北'); },
      railing: ()=>{ showMessage('手に粉が付いた'); increaseDesync(1); },

      vase: ()=>{ showMessage('花は枯れているのに湿っている'); increaseDesync(2); },
      window: ()=>{ showMessage('外の月が赤い四角に見える'); increaseDesync(3); },

      bed: ()=>{ showMessage('布団の盛り上がりは、ただの空気だった'); increaseDesync(3); },
      closet: ()=>{ showMessage('扉の向こうに別の廊下'); increaseDesync(4); },
      lamp: ()=>{ showMessage('点いていないのに熱い'); increaseDesync(2); },

      toybox: ()=>{ showMessage('おもちゃが勝手に転がった'); increaseDesync(4); },
      desk: ()=>{ showMessage('宿題のノートに赤い四角'); increaseDesync(3); },
      graffiti: ()=>{ showMessage('四角が地図記号みたいに見える'); if(!rooms['赤い部屋']) addRedRoom(); increaseDesync(3); },

      grid: ()=>{ showMessage('方眼がうねっている'); increaseDesync(5); }
    };
    (act[action]||(()=>{}))();
  }

  function changeChapter(n){
    if(state.chapter>=n) return;
    state.chapter=n;
    increaseDesync(12);
    updateUI();
  }
  function checkChapterProgress(){
    if(state.chapter===1 && state.steps>=3) changeChapter(2);
    if(state.chapter===2 && state.steps>=7) changeChapter(3);
  }

  /* ======== Red room & Reorganize ======== */
  function addRedRoom(){
    if(rooms['赤い部屋']) return;
    rooms['赤い部屋'] = {
      position3D:{x:30,y:0,z:0},
      exits:{西:'居間'},
      description:'紙にしか存在しないはずの赤い部屋。床は図面用の方眼。',
      color:0x8b0000,
      furniture:[{name:'方眼の床',kind:'prop',pos:[0,-0.2,0],size:[2.8,0.2,2.8],action:'grid'}]
    };
    // 3D add
    const d = rooms['赤い部屋'];
    const g = new THREE.Group();
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(8,8), new THREE.MeshLambertMaterial({color:0x8b0000,transparent:true,opacity:.9}));
    floor.rotation.x=-Math.PI/2; g.add(floor);
    const red = new THREE.PointLight(0xff0000,1.0,12); red.position.set(0,2,0); g.add(red);
    const geo = new THREE.BoxGeometry(2.8,0.2,2.8);
    const mat = new THREE.MeshLambertMaterial({color:0xaa0000,emissive:0x330000});
    const mesh = new THREE.Mesh(geo,mat); mesh.position.set(0,0.1,0);
    mesh.userData={type:'interact',room:'赤い部屋',item:{name:'方眼の床',action:'grid'}};
    g.add(mesh);
    g.position.set(d.position3D.x,d.position3D.y,d.position3D.z);
    scene.add(g);
    roomGroups['赤い部屋']=g;
    interactables['赤い部屋']=[mesh];
    showMessage('赤い部屋が出現した'); updateBlueprint();
  }
  function reorganize(){
    const np = {'廊下':{x:15,y:0,z:5}, '階段':{x:5,y:0,z:20}, '物置':{x:25,y:0,z:15}};
    Object.entries(np).forEach(([n,p])=>{
      if(rooms[n]&&roomGroups[n]){
        rooms[n].position3D = p;
        roomGroups[n].position.set(p.x,p.y,p.z);
      }
    });
    showMessage('家の構造が変わった…'); updateBlueprint();
  }

  /* ======== Movement helpers ======== */
  function movePlayerToRoom(name, entryDir='東', teleport=false){
    const d = rooms[name]; if(!d) return;
    state.currentRoom = name; state.visited.add(name); state.steps++;
    const off=2.2;
    const pos={x:d.position3D.x,y:d.position3D.y+1.6,z:d.position3D.z};
    switch(entryDir){ case'北':pos.z-=off;break; case'南':pos.z+=off;break; case'東':pos.x+=off;break; case'西':pos.x-=off;break; }
    camera.position.set(pos.x,pos.y,pos.z);
    checkChapterProgress();
    updateUI(); updateBlueprint(); advanceTime(3);
    if(!teleport) showMessage(`${name}に入った`);
  }

  /* ======== Ending ======== */
  function checkEnding(){
    if(state.chapter<=3 && state.steps>12){
      showMessage('図面の中心から音がする…');
      setTimeout(()=>{ changeChapter(4); endGame(false); }, 1800);
    }
    if(state.currentRoom==='玄関' && state.inventory.includes('正しい見取り図') && state.chapter>=2){
      showMessage('正しい見取り図に従って扉を開けた');
      setTimeout(()=>endGame(true), 1200);
    }
  }
  async function endGame(escape){
    state.gameEnded=true;
    scene.fog.color.setHex(0x000000); scene.fog.far=5;
    await wait(800);
    if(escape){ showMessage('外の冷たい空気。— 脱出エンド'); beep('chime',0.35,0.22); }
    else{
      showMessage('視界が固定されました'); await wait(1100);
      showMessage('図面の中に閉じ込められた…'); updateBlueprint(); beep('buzz',0.4,0.14);
    }
  }

  /* ======== Ambient events (desync-driven) ======== */
  function startAmbient(){
    setInterval(()=>{
      if(state.gameEnded) return;
      advanceTime(1);
      if(state.desync>=50 && Math.random()<0.20) beep('notify',0.18,0.15);
      if(state.desync>=70 && Math.random()<0.15) beep('chime',0.22,0.16);
      if(state.desync>=88 && Math.random()<0.10) beep('buzz',0.30,0.12);
      // subtle fog flicker
      if(state.desync>=55 && Math.random()<0.18){
        const base = (state.desync>75)?20:30;
        scene.fog.far = 12 + Math.random()*8;
        setTimeout(()=>{ scene.fog.far = base; }, 220);
      }
      updateBlueprint();
    }, 1200);
  }

  /* ======== Main loop ======== */
  let last = performance.now();
  function animate(){
    if(state.gameEnded) return;
    requestAnimationFrame(animate);
    const now = performance.now(); const dt = Math.min(0.033,(now-last)/1000); last=now;
    const obj = nearestInteractable(); void obj;
    updateMovement(dt);
    renderer.render(scene,camera);
  }

  /* ======== Initialize ======== */
  async function initialize(){
    await wait(900);
    el.loading.classList.add('hidden'); el.gameWrap.style.display='grid';
    init3D(); setupInput();
    updateUI(); updateBlueprint(); advanceTime(0);
    startAmbient(); animate();
    showMessage(isMobile?'矢印で移動、[調べる]で探索':'WASDで移動、Eで調べる');
    // ensure audio on any first user gesture
    window.addEventListener('keydown',ensureAudio,{once:true});
    window.addEventListener('mousedown',ensureAudio,{once:true});
    window.addEventListener('touchstart',ensureAudio,{passive:true, once:true});
  }
  initialize();

  })();
  </script>
</body>
</html>
